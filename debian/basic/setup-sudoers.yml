- name: add sudoers with ssh keys
  hosts:
    - containers
  become: yes
  gather_facts: no
  vars:
    users:
      - name: ansible
        github: itsKontra
        password: $6$121$ITNiXBa36cAf9UQisDhiSB/2bvaTnFQFtWaHpImJgUFR7KwHTtP8/vKHoO80qBP2SXs97I4bH80QLTIwNNhmJ0
  tasks:
    - name: add sudo
      apt:
        name: sudo
        state: present
    - name: add user
      user:
        name: "{{ item.name }}"
        password: "{{ item.password }}"
        shell: /bin/bash
      with_items: "{{ users }}"
    - name: enable passwordless sudo
      lineinfile:
        dest: /etc/sudoers.d/99-ansible-users
        state: present
        mode: 0440
        create: yes
        regexp: '^{{ item.name }}'
        line: '{{ item.name }} ALL=(ALL) NOPASSWD: ALL'
        validate: 'visudo -cf %s'
      with_items: "{{ users }}"
    - name: add keys from github
      authorized_key:
        key: "https://github.com/{{ item.github }}.keys"
        user: "{{ item.name }}"
      with_items: "{{ users }}"
